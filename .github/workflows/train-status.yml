name: Train Status (RTT)

on:
  schedule:
    - cron: "*/2 5-8 * * 1-5"   # weekdays, UTC 05:00â€“08:59
  workflow_dispatch:
    inputs:
      force:
        description: "Bypass time gate (run now)"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  group: rtt-board
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      ORIGIN_CRS: "STE"
      DEST_CRS: "WIM"
      BOOKED_DEPART_HHMM: "0744"
      LONDON_TZ: "Europe/London"
      CUTOVER_LOCAL_TIME: "09:00"
      START_LOCAL_TIME: "06:30"
      END_LOCAL_TIME: "09:45"     # let it run through 09:45 local
      WINDOW_START: "0725"
      WINDOW_END: "0845"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (soft)
        id: timegate
        env:
          START: ${{ env.START_LOCAL_TIME }}
          END: ${{ env.END_LOCAL_TIME }}
          LONDON_TZ: ${{ env.LONDON_TZ }}
          FORCE: ${{ github.event.inputs.force }}
        run: |
          if [ "${FORCE}" = "true" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          node - <<'NODE'
          const tz=process.env.LONDON_TZ||'Europe/London';
          const start=process.env.START||'06:30';
          const end  =process.env.END  ||'09:45';
          const hm=new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:false}).format(new Date());
          const toM=s=>parseInt(s.replace(':','').slice(0,2))*60+parseInt(s.replace(':','').slice(2));
          const ok = toM(hm)>=toM(start) && toM(hm)<=toM(end);
          console.log('Local time:',hm,'window',start,'-',end,'->',ok);
          require('fs').appendFileSync(process.env.GITHUB_OUTPUT,`run=${ok}\n`);
          NODE

      - name: Build JSON (safe)
        if: steps.timegate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          LONDON_TZ:   ${{ env.LONDON_TZ }}
          CUTOVER_LOCAL_TIME: ${{ env.CUTOVER_LOCAL_TIME }}
          ORIGIN_CRS:  ${{ env.ORIGIN_CRS }}
          DEST_CRS:    ${{ env.DEST_CRS }}
          BOOKED_DEPART_HHMM: ${{ env.BOOKED_DEPART_HHMM }}
          WINDOW_START: ${{ env.WINDOW_START }}
          WINDOW_END:   ${{ env.WINDOW_END }}
        run: |
          node scripts/fetch_rtt.js
          node scripts/xfer_plan.js

      - name: Commit board JSON (only if changed)
        if: steps.timegate.outputs.run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json xfer.json || true
          git diff --cached --quiet && echo "No changes" || git commit -m "Update board snapshots"
          git rev-parse --verify HEAD && git push || true

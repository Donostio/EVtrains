name: Train Status (RTT)

on:
  schedule:
    # every 1 min, all day; time gate below decides whether to run
    - cron: "*/1 * * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Run now (ignore time windows)"
        required: false
        default: "false"

jobs:
  update-data:
    runs-on: ubuntu-latest

    env:
      # --- core config (single-train tracker: STE->WIM 07:44) ---
      LONDON_TZ: Europe/London
      ORIGIN_CRS: STE
      DEST_CRS: WIM
      BOOKED_DEPART_HHMM: "0744"
      SWITCH_GRACE_MINS: "2"

      # --- transfer window config for xfer_plan.js ---
      # Make this earlier if you want to include earlier departures (see note below)
      WINDOW_START: "0735"
      WINDOW_END: "0835"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        id: gate
        shell: bash
        env:
          FORCE: ${{ github.event.inputs.force || 'false' }}
        run: |
          set -euo pipefail

          now=$(TZ="${LONDON_TZ}" date +%H%M)
          echo "Local time: ${now} windows: 06:00-08:10, 18:00-22:00"

          run="false"
          if [[ "${FORCE}" == "true" ]]; then
            run="true"
          elif [[ "${now}" -ge 0600 && "${now}" -le 0810 ]]; then
            run="true"
          elif [[ "${now}" -ge 1800 && "${now}" -le 2200 ]]; then
            run="true"
          fi

          echo "run=${run}" >> "$GITHUB_OUTPUT"
          echo "Gate result: run=${run}"

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        if: steps.gate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
        run: node scripts/fetch_rtt.js

      - name: Build transfer options (write xfer.json)
        if: steps.gate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
        run: node scripts/xfer_plan.js

      - name: Commit board JSON
        if: steps.gate.outputs.run == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add status.json xfer.json history.jsonl || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Automated status update via cron"
          git pull --rebase origin main
          git push origin HEAD:main
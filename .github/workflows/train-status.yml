name: Train Status (RTT)

on:
  schedule:
    # every 5 minutes
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      FORCE:
        description: "Run even outside time windows"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    env:
      # RTT credentials (match your repo secret names)
      RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
      RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}

      # Timezone used by scripts (and time-gate below)
      LONDON_TZ: Europe/London

      # Transfer window for the bottom-left board (adjust if you want)
      WINDOW_START: "0725"
      WINDOW_END: "0845"

      # Transfer thresholds (optional; keep or tweak)
      MIN_TRANSFER_VIABLE: "1"
      MIN_TRANSFER_OK: "4"

      # If youâ€™re using workflow_dispatch input FORCE
      FORCE: ${{ github.event.inputs.FORCE || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${FORCE}" == "true" ]]; then
            echo "FORCE=true -> skipping time gate"
            exit 0
          fi

          local_hhmm="$(TZ="${LONDON_TZ}" date +%H%M)"
          echo "Local time: ${local_hhmm} windows: 06:00-08:10, 18:00-22:00"

          # morning window
          if [[ "${local_hhmm}" > "0559" && "${local_hhmm}" < "0811" ]]; then
            exit 0
          fi

          # evening window
          if [[ "${local_hhmm}" > "1759" && "${local_hhmm}" < "2201" ]]; then
            exit 0
          fi

          echo "Outside time windows; exiting with 78 to skip."
          exit 78

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        run: node scripts/fetch_rtt.js

      - name: Build transfer options (write xfer.json)
        run: node scripts/xfer_plan.js

      - name: Commit board JSON
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Make sure we're up to date before committing
          git pull --rebase origin main

          git add status.json xfer.json history.jsonl || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Automated status update via cron"
          git push origin HEAD:main

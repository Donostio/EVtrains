name: Train Status (RTT)

permissions:
  contents: write

on:
  schedule:
    - cron: "*/5 5-6 * * 1-5"
  workflow_dispatch:
    inputs:
      force:
        description: "Bypass time gate (run now)"
        required: false
        default: "false"

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      ORIGIN_CRS: "STE"
      DEST_CRS: "WIM"
      BOOKED_DEPART_HHMM: "0744"
      LONDON_TZ: "Europe/London"
      START_LOCAL_TIME: "06:30"
      END_LOCAL_TIME: "07:15"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London window or force)
        env:
          START: "${{ env.START_LOCAL_TIME }}"
          END: "${{ env.END_LOCAL_TIME }}"
          LONDON_TZ: "${{ env.LONDON_TZ }}"
          FORCE: "${{ github.event.inputs.force }}"
        run: |
          if [ "${FORCE}" = "true" ]; then
            echo "Force run enabled; bypassing time gate."
            exit 0
          fi
          node -e "const tz=process.env.LONDON_TZ||'Europe/London';const start=process.env.START||'06:30';const end=process.env.END||'07:15';const fmt=new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:false});const hm=fmt.format(new Date());const toM=s=>parseInt(s.slice(0,2))*60+parseInt(s.slice(3,5));const cur=toM(hm),sM=toM(start),eM=toM(end);const ok=(cur>=sM&&cur<=eM);console.log('Local time:',hm,'window',start,'-',end,'->',ok);if(!ok)process.exit(78);"

      - name: Fetch Realtime Trains + write files
        env:
          RTT_USERNAME: "${{ secrets.RTT_USERNAME }}"
          RTT_PASSWORD: "${{ secrets.RTT_PASSWORD }}"
          ORIGIN_CRS: "${{ env.ORIGIN_CRS }}"
          DEST_CRS: "${{ env.DEST_CRS }}"
          BOOKED_DEPART_HHMM: "${{ env.BOOKED_DEPART_HHMM }}"
          LONDON_TZ: "${{ env.LONDON_TZ }}"
        run: node scripts/fetch_rtt.js

      - name: Commit status.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json history.jsonl
          git commit -m "Update train status snapshot" || echo "No changes"
          git push

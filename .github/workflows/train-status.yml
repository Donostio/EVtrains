name: Train Status (RTT)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      FORCE:
        description: "Run even outside time windows"
        required: false
        default: "false"

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    env:
      RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
      RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}

      LONDON_TZ: Europe/London

      # Transfer window for the bottom-left board (adjust if needed)
      WINDOW_START: "0725"
      WINDOW_END: "0845"

      MIN_TRANSFER_VIABLE: "1"
      MIN_TRANSFER_OK: "4"

      FORCE: ${{ github.event.inputs.FORCE || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        id: timegate
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${FORCE}" == "true" ]]; then
            echo "FORCE=true -> running regardless of time window"
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          local_hhmm="$(TZ="${LONDON_TZ}" date +%H%M)"
          echo "Local time: ${local_hhmm} windows: 06:00-08:10, 18:00-22:00"

          run=false

          # morning window: 06:00–08:10 inclusive of 08:10
          if [[ "${local_hhmm}" > "0559" && "${local_hhmm}" < "0811" ]]; then
            run=true
          fi

          # evening window: 18:00–22:00 inclusive of 22:00
          if [[ "${local_hhmm}" > "1759" && "${local_hhmm}" < "2201" ]]; then
            run=true
          fi

          echo "run=${run}" >> "$GITHUB_OUTPUT"

          if [[ "${run}" != "true" ]]; then
            echo "Outside time windows; skipping update steps (job will succeed)."
          fi

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        if: steps.timegate.outputs.run == 'true'
        run: node scripts/fetch_rtt.js

      - name: Build transfer options (write xfer.json)
        if: steps.timegate.outputs.run == 'true'
        run: node scripts/xfer_plan.js

      - name: Commit board JSON
        if: steps.timegate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git pull --rebase origin main

          git add status.json xfer.json history.jsonl || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Automated status update via cron"
          git push origin HEAD:main

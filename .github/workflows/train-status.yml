name: Train Status (RTT)

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: "Force run outside time windows"
        required: false
        default: "false"
      window_date:
        description: "Override window date (YYYY-MM-DD). Leave blank for today (London)."
        required: false
        default: ""
      window_hhmm:
        description: "Override window anchor time (HHMM). Leave blank for now (London)."
        required: false
        default: ""
      verbose:
        description: "Verbose logging (true/false)"
        required: false
        default: "false"
  schedule:
    - cron: "*/5 6-8 * * 1-5"
    - cron: "*/10 18-22 * * 1-5"

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London

      # --- Your tracked single service (top-left of page) ---
      ORIGIN_CRS: STE
      DEST_CRS: WIM
      DEP_TIME: "0744"                 # keep your original naming
      BOOKED_DEPART_HHMM: "0744"       # compatibility with current fetch_rtt.js

      # --- Transfer board search window (bottom-left of page) ---
      WINDOW_BACK_MINS: "40"
      WINDOW_FWD_MINS: "180"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        id: timegate
        shell: bash
        run: |
          set -euo pipefail

          FORCE="${{ github.event.inputs.force_run || 'false' }}"
          if [ "$FORCE" = "true" ]; then
            echo "Force run requested; not applying time windows."
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          now_hhmm="$(TZ=Europe/London date +%H%M)"
          echo "Local time: $now_hhmm windows: 06:00-08:10, 18:00-22:00"

          in_window=false
          if [ "$now_hhmm" -ge 0600 ] && [ "$now_hhmm" -le 0810 ]; then in_window=true; fi
          if [ "$now_hhmm" -ge 1800 ] && [ "$now_hhmm" -le 2200 ]; then in_window=true; fi

          if [ "$in_window" = "true" ]; then
            echo "Inside time windows; continuing."
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "Outside time windows; skipping update."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        if: steps.timegate.outputs.skip != 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          VERBOSE: ${{ github.event.inputs.verbose || 'false' }}
        run: |
          node scripts/fetch_rtt.js

      - name: Build transfer options (write xfer.json)
        if: steps.timegate.outputs.skip != 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          WINDOW_DATE: ${{ github.event.inputs.window_date || '' }}
          WINDOW_HHMM: ${{ github.event.inputs.window_hhmm || '' }}
          WINDOW_BACK_MINS: ${{ env.WINDOW_BACK_MINS }}
          WINDOW_FWD_MINS: ${{ env.WINDOW_FWD_MINS }}
          VERBOSE: ${{ github.event.inputs.verbose || 'false' }}
        run: |
          node scripts/xfer_plan.js

      - name: Commit updated JSON
        if: steps.timegate.outputs.skip != 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json xfer.json history.jsonl || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Automated status update via cron"
          git pull --rebase origin main
          git push origin HEAD:main

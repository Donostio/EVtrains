name: Train Status (RTT)

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force run outside time windows"
        required: false
        default: "false"
      # Optional: allow you to regenerate a specific date/time window manually if you ever want
      window_date:
        description: "Override window date (YYYY-MM-DD). Leave blank for today (London)."
        required: false
        default: ""
      window_start_hhmm:
        description: "Override window anchor time (HHMM). Leave blank for now (London)."
        required: false
        default: ""
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        id: gate
        shell: bash
        run: |
          set -euo pipefail

          FORCE="${{ github.event.inputs.force || 'false' }}"

          # If manually forced, always run.
          if [ "$FORCE" = "true" ]; then
            echo "Local time: forced run"
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Europe/London local time HHMM
          HHMM="$(TZ=Europe/London date +%H%M)"
          echo "Local time: $HHMM windows: 06:00-08:10, 18:00-22:00"

          # windows (inclusive start, inclusive end)
          in_window=false
          if [ "$HHMM" -ge 0600 ] && [ "$HHMM" -le 0810 ]; then in_window=true; fi
          if [ "$HHMM" -ge 1800 ] && [ "$HHMM" -le 2200 ]; then in_window=true; fi

          if [ "$in_window" = "true" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "Outside time windows; skipping updates."
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        if: steps.gate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          ORIGIN_CRS: "STE"
          DEST_CRS: "WIM"
          DEP_TIME: "0744"
          TZ: "Europe/London"
        run: node scripts/fetch_rtt.js

      - name: Build transfer options (write xfer.json)
        if: steps.gate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          TZ: "Europe/London"

          # Default behaviour: compute around "now" unless you override manually.
          # If you want it to always show the *next morning commute* even during the day,
          # we can change this later â€” but this keeps behaviour simple/stable.
          WINDOW_DATE: ${{ github.event.inputs.window_date }}
          WINDOW_START_HHMM: ${{ github.event.inputs.window_start_hhmm }}

          BACK_MINS: "40"
          FWD_MINS: "180"
          MIN_XFER_MINS: "3"
          MAX_XFER_MINS: "20"

          SRC_CRS: "SRC"
          CLJ_CRS: "CLJ"
          IMW_CRS: "IMW"
        run: node scripts/xfer_plan.js

      - name: Commit updated JSON
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only add files we expect to change
          git add status.json history.jsonl xfer.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Automated status update via cron"
          git push origin HEAD:main

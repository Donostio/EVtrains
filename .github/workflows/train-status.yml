name: Train Status (RTT)

permissions:
  contents: write

on:
  schedule:
    - cron: "*/5 4-8 * * 1-5"   # broad (UTC). Time-gate enforces 06:00–08:00 Europe/London
    - cron: "0 16-22 * * 1-5"   # broad (UTC). Time-gate enforces 18:00–22:00 Europe/London
  workflow_dispatch:
    inputs:
      force:
        description: "Bypass time gate (run now)"
        required: false
        default: "false"

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      ORIGIN_CRS: "STE"
      DEST_CRS: "WIM"
      BOOKED_DEPART_HHMM: "0744"
      LONDON_TZ: "Europe/London"

      # Local windows in London time. The cron is deliberately broad (UTC) to survive BST/GMT changes.
      TIME_WINDOWS_LOCAL: "06:00-08:00,18:00-22:00"

      # Minutes after (actual departure OR booked departure if cancelled) before switching to tomorrow.
      SWITCH_GRACE_MINS: "2"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        env:
          WINDOWS: "${{ env.TIME_WINDOWS_LOCAL }}"
          LONDON_TZ: "${{ env.LONDON_TZ }}"
          FORCE: "${{ github.event.inputs.force }}"
        run: |
          if [ "${FORCE}" = "true" ]; then
            echo "Force run enabled; bypassing time gate."
            exit 0
          fi

          node - <<'NODE'
          const tz = process.env.LONDON_TZ || "Europe/London";
          const windows = (process.env.WINDOWS || "").split(",").map(s=>s.trim()).filter(Boolean);
          const fmt = new Intl.DateTimeFormat("en-GB", { timeZone: tz, hour:"2-digit", minute:"2-digit", hour12:false });
          const hm = fmt.format(new Date()); // "HH:MM"
          const toM = (s)=>{ const [h,m]=s.split(":").map(Number); return h*60+m; };
          const cur = toM(hm);

          const ok = windows.some(w=>{
            const [a,b]=w.split("-").map(x=>x.trim());
            if(!a || !b) return false;
            return cur >= toM(a) && cur <= toM(b);
          });

          console.log("Local time:", hm, "windows:", windows.join(", "), "->", ok);
          if(!ok) process.exit(78); // neutral "not scheduled" exit
          NODE

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        env:
          RTT_USERNAME: "${{ secrets.RTT_USERNAME }}"
          RTT_PASSWORD: "${{ secrets.RTT_PASSWORD }}"
          ORIGIN_CRS: "${{ env.ORIGIN_CRS }}"
          DEST_CRS: "${{ env.DEST_CRS }}"
          BOOKED_DEPART_HHMM: "${{ env.BOOKED_DEPART_HHMM }}"
          LONDON_TZ: "${{ env.LONDON_TZ }}"
          SWITCH_GRACE_MINS: "${{ env.SWITCH_GRACE_MINS }}"
        run: node scripts/fetch_rtt.js

      - name: Build SRC-CLJ-IMW transfer options (write xfer.json)
        env:
          RTT_USERNAME: "${{ secrets.RTT_USERNAME }}"
          RTT_PASSWORD: "${{ secrets.RTT_PASSWORD }}"
          LONDON_TZ: "Europe/London"
        run: node scripts/xfer_plan.js

      - name: Commit board JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json xfer.json history.jsonl
          git commit -m "Update board snapshots" || echo "No changes"
          git push

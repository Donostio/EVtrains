name: Train Status (RTT)

permissions:
  contents: write

on:
  schedule:
    # Wide UTC envelopes; local London gate decides whether to proceed (DST-safe)
    - cron: "*/5 4-9 * * 1-5"
    - cron: "*/5 16-23 * * 1-5"
  workflow_dispatch:
    inputs:
      force:
        description: "Force run outside time windows"
        required: false
        default: "false"
      window_date:
        description: "Override window date (YYYY-MM-DD). Leave blank for today (London)."
        required: false
        default: ""
      window_start_hhmm:
        description: "Override window anchor time (HHMM). Leave blank for now (London)."
        required: false
        default: ""

jobs:
  update-data:
    runs-on: ubuntu-latest

    env:
      # Single-train tracker (top-left)
      ORIGIN_CRS: "STE"
      DEST_CRS: "WIM"
      BOOKED_DEPART_HHMM: "0744"

      # London-local behaviour
      LONDON_TZ: "Europe/London"
      TIME_WINDOWS_LOCAL: "06:00-08:10,18:00-22:00"

      # Fetch script uses this when deciding “today vs tomorrow”
      SWITCH_GRACE_MINS: "2"

      # Transfer planner defaults
      BACK_MINS: "40"
      FWD_MINS: "180"
      MIN_XFER_MINS: "3"
      MAX_XFER_MINS: "20"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Time gate (Europe/London windows or force)
        id: gate
        shell: bash
        run: |
          set -euo pipefail

          FORCE="${{ github.event.inputs.force || 'false' }}"

          if [ "$FORCE" = "true" ]; then
            echo "Force run enabled; bypassing time gate."
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Current London time HH:MM
          HM="$(TZ=${LONDON_TZ} date +%H:%M)"
          echo "Local time: $HM windows: ${TIME_WINDOWS_LOCAL}"

          # Convert HH:MM -> minutes
          to_mins () { echo $((10#${1%:*}*60 + 10#${1#*:})); }

          CUR="$(to_mins "$HM")"

          ok=false
          IFS=',' read -ra WINS <<< "${TIME_WINDOWS_LOCAL}"
          for w in "${WINS[@]}"; do
            w="$(echo "$w" | xargs)"
            start="${w%-*}"
            end="${w#*-}"
            s="$(to_mins "$start")"
            e="$(to_mins "$end")"
            if [ "$CUR" -ge "$s" ] && [ "$CUR" -le "$e" ]; then
              ok=true
              break
            fi
          done

          if [ "$ok" = "true" ]; then
            echo "Inside time window; proceeding."
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "Outside time windows; skipping updates."
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        if: steps.gate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          ORIGIN_CRS: ${{ env.ORIGIN_CRS }}
          DEST_CRS: ${{ env.DEST_CRS }}
          BOOKED_DEPART_HHMM: ${{ env.BOOKED_DEPART_HHMM }}
          LONDON_TZ: ${{ env.LONDON_TZ }}
          SWITCH_GRACE_MINS: ${{ env.SWITCH_GRACE_MINS }}
        run: node scripts/fetch_rtt.js

      - name: Build transfer options (write xfer.json)
        if: steps.gate.outputs.run == 'true'
        env:
          RTT_USERNAME: ${{ secrets.RTT_USERNAME }}
          RTT_PASSWORD: ${{ secrets.RTT_PASSWORD }}
          TZ: ${{ env.LONDON_TZ }}

          WINDOW_DATE: ${{ github.event.inputs.window_date }}
          WINDOW_START_HHMM: ${{ github.event.inputs.window_start_hhmm }}

          BACK_MINS: ${{ env.BACK_MINS }}
          FWD_MINS: ${{ env.FWD_MINS }}
          MIN_XFER_MINS: ${{ env.MIN_XFER_MINS }}
          MAX_XFER_MINS: ${{ env.MAX_XFER_MINS }}
        run: node scripts/xfer_plan.js

      - name: Commit updated JSON
        if: steps.gate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add status.json xfer.json history.jsonl || true

          # No-op if nothing changed
          git diff --cached --quiet && { echo "No changes to commit"; exit 0; }

          git commit -m "Update board snapshots"

          # Push; if non-fast-forward (rare concurrency), rebase then push again
          git push || (git pull --rebase && git push)

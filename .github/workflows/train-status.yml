name: Train Status (RTT)

on:
  schedule:
    - cron: "*/5 4-9 * * 1-5"
    - cron: "*/10 17-22 * * 0-6"
  workflow_dispatch:
    inputs:
      force:
        description: "Run even if outside time windows"
        required: false
        default: "false"

concurrency:
  group: train-status
  cancel-in-progress: false

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Time gate (Europe/London windows or force)
        id: timegate
        shell: bash
        env:
          FORCE: ${{ github.event.inputs.force }}
        run: |
          set -euo pipefail

          if [ "${FORCE:-false}" = "true" ]; then
            echo "Forced run."
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NOW=$(TZ=Europe/London date +%H:%M)
          # Edit windows here:
          # Morning: 06:00–09:15
          # Evening: 18:00–22:00
          in_window=false
          if [[ "$NOW" > "06:00" && "$NOW" < "09:15" ]]; then in_window=true; fi
          if [[ "$NOW" > "18:00" && "$NOW" < "22:00" ]]; then in_window=true; fi

          echo "Local time: $NOW windows: 06:00-09:15, 18:00-22:00 -> $in_window"
          echo "should_run=$in_window" >> "$GITHUB_OUTPUT"

      - name: Fetch Realtime Trains (STE->WIM) and write status.json
        if: steps.timegate.outputs.should_run == 'true'
        env:
          RTT_USER: ${{ secrets.RTT_USER }}
          RTT_PASS: ${{ secrets.RTT_PASS }}
        run: |
          node fetch_rtt.js

      - name: Build SRC-CLJ-IMW transfer options (write xfer.json)
        if: steps.timegate.outputs.should_run == 'true'
        run: |
          node xfer_plan.js

      - name: Commit board JSON
        if: steps.timegate.outputs.should_run == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add status.json xfer.json history.jsonl || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Automated status update via cron"
          git push origin HEAD:main

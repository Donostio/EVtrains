<script>
const fmt = t => t ? t.slice(0,2)+":"+t.slice(2) : "—";

/* ---------- TOP LEFT (STE→WIM) ---------- */
function renderTL(s){
  const el = document.getElementById('tl_app');
  if(!s || s.error){
    el.innerHTML = `<div class="route">STE-WIM</div><div class="time red">Error</div>`;
    return;
  }
  const o = s.origin || {};
  const d = s.destination || {};
  let status = s.status || "on_time";
  if (o.isCancelled || d.isCancelled) status = "cancelled";

  const depBooked = o.bookedDeparture || s.gbttBookedDeparture || null;
  const depReal   = o.realtimeDeparture || null;
  const arrBooked = d.bookedArrival || null;
  const arrReal   = d.realtimeArrival || null;

  let timeHTML = "";
  if (status === "cancelled"){
    timeHTML = `<div class="time red"><span class="strike">${fmt(depBooked)}</span> CANCELLED</div>`;
  } else if (status === "delayed" || status === "early"){
    timeHTML = `<div class="time ${status==='delayed'?'amber':'green'}">
      ${fmt(depReal || depBooked)}${depBooked ? ` <span class="muted">(${fmt(depBooked)})</span>` : ""}
      ${(arrReal || arrBooked)
          ? ` <span class="muted">-</span> ${fmt(arrReal || arrBooked)}${arrBooked ? ` <span class="muted">(${fmt(arrBooked)})</span>` : ""}`
          : "" }
    </div>`;
  } else {
    timeHTML = `<div class="time green">${fmt(depReal || depBooked)}</div>`;
  }

  const platHTML = (o.platform || d.platform)
    ? `<div class="sub">Plat ${o.platform || "?"} · Plat ${d.platform || "?"}</div>`
    : "";

  el.innerHTML = `<div class="route">STE-WIM</div>${timeHTML}${platHTML}`;
}
async function loadTL(){
  try{
    const r = await fetch('./status.json?ts='+Date.now(), { cache:'no-store' });
    renderTL(await r.json());
  }catch{
    renderTL({ error:true });
  }
}
loadTL();
setInterval(loadTL, 60000);

/* ---------- BOTTOM LEFT (SRC→CLJ→IMW) ---------- */
function renderBL(data){
  const el = document.getElementById('bl_app');
  if(!data || data.error){ el.innerHTML = `<div class="time red">No data</div>`; return; }

  const pill = s => s==='cancelled'?'red':s==='delayed'?'amber':s==='early'?'green':'green';
  const parts = [];

  // Direct 07:25 -> 07:43
  if(data.direct){
    const d = data.direct;
    const color = pill(d.status);
    parts.push(`
      <div class="time ${color}">
        ${fmt(d.srcDepReal || d.srcDep)} <span class="muted">(${fmt(d.srcDep)})</span>
        <span class="muted">-</span>
        ${fmt(d.imwArrReal || d.imwArr)}${d.imwArr ? ` <span class="muted">(${fmt(d.imwArr)})</span>` : ""}
      </div>
      <div class="sub">SRC plat ${d.srcPlat||"?"} → IMW plat ${d.imwPlat||"?"}</div>
    `);
  } else {
    parts.push(`<div class="sub muted">No direct SRC→IMW 07:25 service for ${data.datePath}</div>`);
  }

  // Next legs with connections
  for(const leg of (data.legs || [])){
    parts.push(`
      <div class="sub">
        SRC ${fmt(leg.srcDepReal||leg.srcDep)} <span class="muted">(${fmt(leg.srcDep)})</span>
        → CLJ ${fmt(leg.cljArrReal||leg.cljArr)}
        · SRC plat ${leg.srcPlat||"?"}${leg.cljPlatArr?` · CLJ arr plat ${leg.cljPlatArr}`:""}
      </div>
    `);
    parts.push((leg.connections||[]).slice(0,2).map(c=>{
      const ccol = pill(c.status);
      return `<div class="sub">• <span class="${ccol}">${fmt(c.cljDepReal||c.cljDep)}→${fmt(c.imwArrReal||c.imwArr)}</span> (CLJ plat ${c.cljPlat||"?"} → IMW plat ${c.imwPlat||"?"})</div>`;
    }).join(""));
  }
  if(!data.legs?.length){
    parts.push(`<div class="sub muted">No CLJ connections ≥1 min after arrival.</div>`);
  }

  el.innerHTML = parts.join("");
}
async function loadBL(){
  try{
    const r = await fetch('./xfer.json?ts='+Date.now(), { cache:'no-store' });
    renderBL(await r.json());
  }catch{
    renderBL({ error:true });
  }
}
loadBL();
setInterval(loadBL, 60000);
</script>

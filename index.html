<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Morning Board</title>
<style>
  :root{
    --bg:#000; --fg:#eaeaea; --muted:#9aa0a6;
    --green:#58d27a; --amber:#ffa000; --red:#ff5252;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{height:100%; display:flex; flex-direction:column; padding:28px 36px; box-sizing:border-box;}
  .row{display:flex; gap:22px; align-items:flex-start;}
  .card{flex:1; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:24px; padding:22px 24px; min-height:220px;}
  .title{font-size:18px; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); margin:0 0 10px;}
  .tl-stack{display:flex; flex-direction:column; align-items:center; gap:8px;}
  .route{font-size:46px; font-weight:800; letter-spacing:0.05em;}
  .time{font-size:38px; font-weight:700;}
  .sub{font-size:18px; color:var(--muted);}
  .green{color:var(--green);}
  .amber{color:var(--amber);}
  .red{color:var(--red);}
  .strike{text-decoration:line-through;}
  .tiny{font-size:14px; color:var(--muted); margin-top:10px}
  table{width:100%; border-collapse:collapse; margin-top:8px;}
  th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:left;}
  th{color:var(--muted); font-weight:600; font-size:14px; text-transform:uppercase; letter-spacing:0.06em;}
  td{font-size:16px;}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div class="card">
      <h2 class="title">Direct</h2>
      <div id="tl_app"></div>
      <div class="tiny" id="tl_meta"></div>
    </div>
    <div class="card">
      <h2 class="title">Transfer</h2>
      <div id="bl_app"></div>
      <div class="tiny" id="bl_meta"></div>
    </div>
  </div>
</div>

<script>
const fmt = t => t ? t.slice(0,2)+":"+t.slice(2) : "—";
const LONDON_TZ = "Europe/London";
const colorFor = st => st==='cancelled' ? 'red' : (st==='delayed' ? 'amber' : 'green');

function timeAtom(booked,real,status){
  if(status==='cancelled') return `<span class="red"><span class="strike">${fmt(booked)}</span></span>`;
  if(status==='delayed'&&real&&real!==booked) return `<span class="amber">${fmt(real)}</span> <span class="sub"><span class="strike">${fmt(booked)}</span></span>`;
  if(real&&real!==booked) return `<span>${fmt(real)}</span> <span class="sub"><span class="strike">${fmt(booked)}</span></span>`;
  return `<span>${fmt(booked)}</span>`;
}
function pairAtoms(depB,depR,arrB,arrR,status){
  const c=colorFor(status);
  return `${timeAtom(depB,depR,status)} <span class="${c}">-</span> ${timeAtom(arrB,arrR,status)}`;
}

function londonYMD(offsetDays=0){
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: LONDON_TZ, year:'numeric', month:'2-digit', day:'2-digit'
  }).formatToParts(new Date());
  const y = +parts.find(p=>p.type==='year').value;
  const m = +parts.find(p=>p.type==='month').value;
  const d = +parts.find(p=>p.type==='day').value;
  const dt = new Date(Date.UTC(y, m-1, d + offsetDays));
  return dt.toISOString().slice(0,10);
}

/* ---------- TL (STE→WIM) ---------- */
function renderTL(s){
  const el=document.getElementById('tl_app');
  if(!s||s.error){
    el.innerHTML = `<div class="tl-stack"><div class="route">STE-WIM</div><div class="time red">Error</div></div>`;
    return;
  }

  const o=s.origin||{}, d=s.destination||{};
  const status=(o.isCancelled||d.isCancelled||s.status==='cancelled')?'cancelled':(s.status==='delayed'?'delayed':'on_time');
  const depB=o.bookedDeparture||s.gbttBookedDeparture, depR=o.realtimeDeparture;
  const arrB=d.bookedArrival, arrR=d.realtimeArrival;

  const today = londonYMD(0);
  const tomorrow = londonYMD(1);
  const runDateRaw = (s.runDate || s.date || "").slice(0,10);
  const dayLabel = runDateRaw===today ? "Today" : (runDateRaw===tomorrow ? "Tomorrow" : (runDateRaw || "—"));

  const content = status==='cancelled'
    ? `<div class="time red"><span class="strike">${fmt(depB)}</span> CANCELLED</div>`
    : `<div class="time">${pairAtoms(depB,depR,arrB,arrR,status)}</div>`;

  const plat=(o.platform||d.platform)?`<div class="sub">Plat ${o.platform||"?"} · Plat ${d.platform||"?"}</div>`:"";

  el.innerHTML = `<div class="tl-stack">
    <div class="sub">${dayLabel}</div>
    <div class="route">STE-WIM</div>
    ${content}
    ${plat}
  </div>`;
}

async function loadTL(){
  try{
    const r=await fetch('./status.json?ts='+Date.now(),{cache:'no-store'});
    renderTL(await r.json());
  }catch{
    renderTL({error:true});
  }
}
loadTL();
setInterval(loadTL,60000);

/* ---------- BL (SRC→CLJ→IMW) ---------- */
function renderBL(dat){
  const el=document.getElementById('bl_app');
  if(!dat||dat.error){
    el.innerHTML = `<div class="tl-stack"><div class="route">SRC-IMW</div><div class="time red">Error</div></div>`;
    return;
  }
  const legs=dat.legs||[];
  if(!legs.length){
    el.innerHTML = `<div class="tl-stack"><div class="route">SRC-IMW</div><div class="sub">No options</div></div>`;
    return;
  }
  const rows = legs.map(L=>{
    const a=L.a||{}, b=L.b||{};
    const st=L.status||'';
    const c=colorFor(st==='cancelled'?'cancelled':(st==='delayed'?'delayed':'on_time'));
    return `<tr>
      <td>${fmt(a.dep)}–${fmt(a.arr)}<br><span class="sub">${a.from}→${a.to}</span></td>
      <td>${fmt(b.dep)}–${fmt(b.arr)}<br><span class="sub">${b.from}→${b.to}</span></td>
      <td class="${c}">${st.replace('_',' ')}</td>
    </tr>`;
  }).join("");
  el.innerHTML = `<table>
    <thead><tr><th>Leg 1</th><th>Leg 2</th><th>Status</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

async function loadBL(){
  try{
    const r=await fetch('./xfer.json?ts='+Date.now(),{cache:'no-store'});
    renderBL(await r.json());
  }catch{
    renderBL({error:true});
  }
}
loadBL();
setInterval(loadBL,120000);
</script>
</body>
</html>

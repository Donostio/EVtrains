<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Morning Board</title>
<style>
  :root{
    --bg:#000; --fg:#eaeaea; --muted:#9aa0a6;
    --green:#58d27a; --amber:#ffa000; --red:#ff5252;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* Center the whole 2×2 board and reduce the middle gap */
  .board{
    height:100%;
    max-width:1320px;              /* pulls tiles toward the center on wide screens */
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:1fr 1fr;
    gap:24px;                      /* consistent spacing between tiles */
    padding:24px;
    box-sizing:border-box;
  }
  .tile{
    background:#000;               /* true black tiles */
    color:var(--fg);
    display:grid;
    place-items:center;
    overflow:hidden;
    border-radius:0;               /* no borders */
  }
  .inner{ width:100%; height:100%; display:grid; place-items:center; }

  iframe{ width:100%; height:100%; border:none; background:#000; }

  /* ---------- TOP-LEFT (STE→WIM) ---------- */
  #tl_app{ text-align:center }
  .route{ font-weight:800; letter-spacing:.06em; margin-bottom:.5rem;
          font-size:clamp(14px,2.2vw,22px) }
  .time{  font-weight:800; line-height:1.1; white-space:nowrap;
          font-size:clamp(32px,6vw,72px) }
  .sub{   font-size:clamp(12px,1.6vw,16px); color:var(--muted); margin-top:.35rem }
  .small{ font-size:.5em }
  .strike{text-decoration:line-through}
  .green{color:var(--green)} .amber{color:var(--amber)} .red{color:var(--red)} .muted{color:var(--muted)}

  /* ---------- BOTTOM-LEFT (SRC→CLJ→IMW) ---------- */
  #bl_app{ width:min(95%, 980px); margin:0 auto; }

  .title{
    color:var(--fg); font-weight:800; letter-spacing:.06em; text-align:center;
    font-size:clamp(12px,1.6vw,18px); margin:0;
  }
  .time-xs{
    font-weight:800; line-height:1.1; white-space:nowrap;
    font-size:clamp(14px,1.9vw,24px);
  }

  .direct-block{ text-align:center; width:100% }
  .direct-line{ margin-top:.25rem }
  .direct-gap{ height:clamp(12px,1.5vw,20px) }

  /* 3-column “table” */
  .xfer-wrap{ width:100%; display:grid; grid-template-columns:1fr; row-gap:10px }
  .xfer-header{
    display:grid;
    grid-template-columns: 1fr 0.9fr 1fr;   /* transfer sits close to times */
    column-gap:16px;
    align-items:end;
  }
  .xfer-header .title{ margin-bottom:.2rem }
  .xrow{
    display:grid;
    grid-template-columns: 1fr 0.9fr 1fr;   /* match header */
    column-gap:16px;
    align-items:center;
    padding:6px 0;
  }

  /* Left column: times then platform (on its own line) */
  .left-cell{ display:flex; flex-direction:column; align-items:center; text-align:center }

  /* Middle & Right columns: maintain pair-on-one-line behaviour */
  .mid-cell, .right-cell{ display:flex; flex-direction:column; gap:.7rem }
  .right-cell{ align-items:flex-start; text-align:left }

  /* One connection row: transfer | times, kept together */
  .pair{
    display:grid;
    grid-template-columns: max-content max-content;
    align-items:baseline;
    column-gap:12px;
    white-space:nowrap;        /* prevent split across multiple lines */
  }
  .transfer{
    font-size:clamp(12px,1.7vw,18px);
    word-break:keep-all;
  }
  .trans-ok{ color:var(--fg) }
  .trans-warn{ color:var(--red) }
  .transfer .arrow{ margin-left:.35em }

  /* ---------- Responsive tweaks ---------- */
  @media (max-width: 900px){
    .board{ gap:16px; padding:16px }
    .xrow{ column-gap:12px }
    .pair{ column-gap:10px }
  }
  @media (max-width: 700px){
    .board{ gap:12px; padding:12px }
    .xfer-header .title{ margin-bottom:.1rem }
    .mid-cell, .right-cell{ gap:.9rem }   /* more vertical breathing room between pairs */
  }

  /* Landscape phones: reduce type a bit more to avoid overflow, no iframe scaling */
  @media (max-height: 480px) and (orientation: landscape){
    .time{ font-size:clamp(26px,5.2vw,60px) }
    .time-xs{ font-size:clamp(13px,1.7vw,22px) }
    .title{ font-size:clamp(11px,1.4vw,16px) }
    .sub{ font-size:clamp(10px,1.3vw,14px) }
  }
</style>
</head>
<body>
  <div class="board">
    <!-- TOP LEFT -->
    <section class="tile"><div class="inner" id="tl_app">Loading…</div></section>

    <!-- TOP RIGHT -->
    <section class="tile"><div class="inner">
      <iframe src="https://donostio.github.io/DLstatus/?embed=1&theme=dark" loading="lazy" referrerpolicy="no-referrer"></iframe>
    </div></section>

    <!-- BOTTOM LEFT -->
    <section class="tile"><div class="inner" id="bl_app">Loading…</div></section>

    <!-- BOTTOM RIGHT -->
    <section class="tile"><div class="inner">
      <iframe src="https://donostio.github.io/EvieWeather/?embed=1&theme=dark" loading="lazy" referrerpolicy="no-referrer"></iframe>
    </div></section>
  </div>

<script>
const fmt = t => t ? t.slice(0,2)+":"+t.slice(2) : "—";
const colorFor = st => st==='cancelled' ? 'red' : (st==='delayed' ? 'amber' : 'green');

function timeAtom(booked,real,status){
  if(status==='cancelled') return `<span class="red"><span class="strike">${fmt(booked)}</span></span>`;
  if(status==='delayed'&&real&&real!==booked) return `<span class="muted small">(${fmt(booked)})</span> <span class="amber">${fmt(real)}</span>`;
  return `<span class="green">${fmt(booked)}</span>`;
}
function pairAtoms(depB,depR,arrB,arrR,status){
  const c=colorFor(status);
  return `${timeAtom(depB,depR,status)} <span class="${c}">-</span> ${timeAtom(arrB,arrR,status)}`;
}

/* ---------- TOP LEFT (STE→WIM) ---------- */
function renderTL(s){
  const el=document.getElementById('tl_app');
  if(!s||s.error){el.innerHTML=`<div class="route">STE-WIM</div><div class="time red">Error</div>`;return;}
  const o=s.origin||{}, d=s.destination||{};
  const status=(o.isCancelled||d.isCancelled)?'cancelled':(s.status==='delayed'?'delayed':'on_time');
  const depB=o.bookedDeparture||s.gbttBookedDeparture, depR=o.realtimeDeparture;
  const arrB=d.bookedArrival, arrR=d.realtimeArrival;
  const content = status==='cancelled'
    ? `<div class="time red">${timeAtom(depB,null,'cancelled')} CANCELLED</div>`
    : `<div class="time">${pairAtoms(depB,depR,arrB,arrR,status)}</div>`;
  const plat=(o.platform||d.platform)?`<div class="sub">Plat ${o.platform||"?"} · Plat ${d.platform||"?"}</div>`:"";
  el.innerHTML=`<div class="route">STE-WIM</div>${content}${plat}`;
}
async function loadTL(){try{const r=await fetch('./status.json?ts='+Date.now(),{cache:'no-store'});renderTL(await r.json());}catch{renderTL({error:true});}}
loadTL(); setInterval(loadTL,60000);

/* ---------- BOTTOM LEFT (SRC→CLJ→IMW) ---------- */
function renderBL(data){
  const el=document.getElementById('bl_app');
  if(!data||data.error){ el.innerHTML=`<div class="time-xs red">No data</div>`; return; }

  const toM=t=>t?(+t.slice(0,2))*60+(+t.slice(2)):null;
  const out=[];

  /* Direct */
  const platInline=data.direct?` <span class="muted small">Plat ${data.direct.srcPlat||"?"} · Plat ${data.direct.imwPlat||"?"}</span>`:"";
  out.push(`<div class="direct-block"><div class="title">SRC-IMW (direct)${platInline}</div>`);
  if(data.direct){
    const st=data.direct.status==='delayed'?'delayed':(data.direct.status==='cancelled'?'cancelled':'on_time');
    out.push(st==='cancelled'
      ? `<div class="time-xs red direct-line">${timeAtom(data.direct.srcDep,null,'cancelled')} CANCELLED</div>`
      : `<div class="time-xs direct-line">${pairAtoms(data.direct.srcDep,data.direct.srcDepReal,data.direct.imwArr,data.direct.imwArrReal,st)}</div>`
    );
  }else{
    out.push(`<div class="sub muted">No direct SRC→IMW 07:25 service for ${data.datePath}</div>`);
  }
  out.push(`</div><div class="direct-gap"></div>`);

  /* Headers */
  out.push(`
    <div class="xfer-wrap">
      <div class="xfer-header">
        <div class="title">SRC-CLJ</div>
        <div class="title">Transfer</div>
        <div class="title">CLJ-IMW</div>
      </div>
  `);

  /* Rows */
  for(const leg of (data.legs||[])){
    let legStatus='on_time';
    const srcLate=leg.srcDepReal&&toM(leg.srcDepReal)>toM(leg.srcDep);
    const arrLate=leg.cljArrReal&&toM(leg.cljArrReal)>toM(leg.cljArr);
    if(srcLate||arrLate) legStatus='delayed';

    const leftPair=pairAtoms(leg.srcDep,leg.srcDepReal,leg.cljArr,leg.cljArrReal,legStatus);

    const conns=(leg.connections||[]).slice(0,2).map(c=>{
      const st=c.status==='delayed'?'delayed':(c.status==='cancelled'?'cancelled':'on_time');
      const pair=st==='cancelled'
        ? `${timeAtom(c.cljDep||'',null,'cancelled')} CANCELLED`
        : pairAtoms(c.cljDep,c.cljDepReal,c.imwArr,c.imwArrReal,st);

      const mArr=toM(leg.cljArrReal||leg.cljArr), mDep=toM(c.cljDepReal||c.cljDep);
      let xfer=(mArr!=null&&mDep!=null)?(mDep-mArr):null; if(xfer!=null&&xfer<0) xfer=null;
      const warn=(xfer!=null&&xfer<4), mins=xfer==null?'?':xfer;
      const transfer=`<span class="transfer ${warn?'trans-warn':'trans-ok'}">${mins}&nbsp;min · plat&nbsp;${c.cljPlat||"?"}<span class="arrow"> →</span>${warn?'':''}</span>`;
      return {transfer,pair};
    });

    const midCol = conns.map(p=>`<div class="pair"><div>${p.transfer}</div><div></div></div>`).join("");
    const rightCol= conns.map(p=>`<div class="pair"><div></div><div class="time-xs">${p.pair}</div></div>`).join("");

    out.push(`
      <div class="xrow">
        <div class="left-cell">
          <div class="time-xs">${leftPair}</div>
          <div class="sub">plat ${leg.cljPlatArr || "?"}</div>
        </div>
        <div class="mid-cell">${midCol || `<div class="transfer trans-ok">—</div>`}</div>
        <div class="right-cell">${rightCol || `<div class="time-xs muted">—</div>`}</div>
      </div>
    `);
  }

  out.push(`</div>`);
  el.innerHTML=out.join("");
}
async function loadBL(){try{const r=await fetch('./xfer.json?ts='+Date.now(),{cache:'no-store'});renderBL(await r.json());}catch{renderBL({error:true});}}
loadBL(); setInterval(loadBL,60000);
</script>
</body>
</html>

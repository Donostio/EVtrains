<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Morning Board</title>
<style>
  :root{
    --bg:#000; --fg:#eaeaea; --muted:#9aa0a6;
    --green:#58d27a; --red:#ff5252;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* 2×2 centred board */
  .board{
    height:100%;
    max-width:1320px;
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:1fr 1fr;
    gap:24px;
    padding:24px;
    box-sizing:border-box;
  }
  .tile{ background:#000; color:var(--fg); display:grid; place-items:center; overflow:hidden }
  .inner{ width:100%; height:100%; display:grid; place-items:center }
  iframe{ width:100%; height:100%; border:none; background:#000 }

  /* ---------- Shared typography ---------- */
  .sub{   font-size:clamp(12px,1.6vw,18px); color:var(--muted) }
  .muted{ color:var(--muted) }
  .green{ color:var(--green) }
  .red{ color:var(--red) }
  .strike{ text-decoration:line-through }

  /* ---------- TL (STE→WIM) ---------- */
  #tl_app{ text-align:center }
  .tl-stack{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:0.02rem;
  }
  /* STE-WIM half-size */
  .route{ font-size:clamp(18px,3.3vw,38px); font-weight:900; letter-spacing:0.06em }
  .time{  font-size:clamp(26px,5.0vw,60px); font-weight:800; letter-spacing:0.02em }

  /* ---------- BL (xfer) ---------- */
  #bl_app{ width:100%; height:100%; padding:22px 26px; box-sizing:border-box }
  .title{
    font-size:clamp(12px,1.5vw,18px);
    letter-spacing:0.08em;
    text-transform:uppercase;
    color:var(--muted);
  }
  .time-xs{ font-size:clamp(16px,2.2vw,28px); font-weight:800; letter-spacing:0.02em }

  /* Mini “card” style matching TL */
  .mini-stack{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:0.02rem;
    text-align:center;
  }
  .route-mini{ font-size:clamp(14px,2.6vw,30px); font-weight:900; letter-spacing:0.06em }
  .time-mini{  font-size:clamp(26px,5.0vw,60px); font-weight:800; letter-spacing:0.02em }
  .direct-gap{ height:18px }

  .xfer-wrap{ width:100% }
  .xfer-header{
    display:grid;
    grid-template-columns: 1fr 0.9fr 1fr;
    column-gap:14px;
    align-items:end;
    margin-bottom:8px;
  }
  .xrow{
    display:grid;
    grid-template-columns: 1fr 0.9fr 1fr;
    column-gap:14px;
    align-items:center;
    padding:4px 0;
  }

  /* Left column: times then BOTH platforms underneath */
  .left-cell{ display:flex; flex-direction:column; align-items:center; text-align:center }
  .plat-both{ margin-top:.12rem }

  /* Middle & Right columns */
  .mid-cell{ display:flex; flex-direction:column; gap:.7rem; align-items:flex-end; }
  .right-cell{ display:flex; flex-direction:column; gap:.7rem; align-items:flex-start; text-align:left }

  /* Transfer line */
  .pair{
    display:grid;
    grid-template-columns:max-content max-content;
    align-items:baseline;
    column-gap:8px;
    white-space:nowrap;
  }
  .transfer{ font-size:clamp(12px,1.7vw,18px); text-align:right }
  .transfer strong{ font-weight:800 }
  .trans-ok{ color:var(--fg) } .trans-warn{ color:var(--red) }
  .transfer .arrow{ margin-left:.35em }

  /* ---------- District tile overlays ---------- */
  .dl-wrap{ position:relative; width:100%; height:100%; }
  .dl-planned{
    position:absolute;
    top:44px;
    left:50%;
    transform:translateX(-50%);
    z-index:5;
    text-align:center;
    pointer-events:none;
    max-width:92%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    display:none;
  }
  .dl-label{
    position:absolute;
    top:72px;
    left:50%;
    transform:translateX(-50%);
    z-index:5;
    text-align:center;
    pointer-events:none;
  }
</style>
</head>
<body>
  <div class="board">
    <!-- TOP LEFT -->
    <section class="tile"><div class="inner" id="tl_app">Loading…</div></section>

    <!-- TOP RIGHT -->
    <section class="tile">
      <div class="inner dl-wrap">
        <div id="dl_planned" class="dl-planned sub"></div>
        <div class="dl-label sub">Now</div>
        <iframe
          src="https://donostio.github.io/DLstatus/?embed=1&theme=dark"
          loading="lazy"
          referrerpolicy="no-referrer"></iframe>
      </div>
    </section>

    <!-- BOTTOM LEFT -->
    <section class="tile"><div class="inner" id="bl_app">Loading…</div></section>

    <!-- BOTTOM RIGHT -->
    <section class="tile"><div class="inner">
      <iframe src="https://donostio.github.io/EvieWeather/?embed=1&theme=dark" loading="lazy" referrerpolicy="no-referrer"></iframe>
    </div></section>
  </div>

<script>
/* ---------------- basics ---------------- */
const fmt = t => t ? String(t).padStart(4,"0").slice(0,2)+":"+String(t).padStart(4,"0").slice(2,4) : "—";
const LONDON_TZ = "Europe/London";

function londonYMD(offsetDays=0){
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: LONDON_TZ, year:"numeric", month:"2-digit", day:"2-digit"
  }).formatToParts(new Date());
  const y = +parts.find(p=>p.type==="year").value;
  const m = +parts.find(p=>p.type==="month").value;
  const d = +parts.find(p=>p.type==="day").value;
  const dt = new Date(Date.UTC(y, m-1, d + offsetDays));
  return dt.toISOString().slice(0,10);
}
function londonISODate(offsetDays=0){ return londonYMD(offsetDays); }
function shortDate(iso){ // DD/MM
  if(!iso || iso.length < 10) return iso || "";
  return `${iso.slice(8,10)}/${iso.slice(5,7)}`;
}

/* ---------- normalise times to HHMM digits for reliable comparison ---------- */
function normHHMM(x){
  if(x == null) return null;
  const s = String(x).trim();
  if(!s) return null;
  const digits = s.replace(/[^0-9]/g, ""); // removes ":" etc
  if(digits.length === 4) return digits;
  if(digits.length === 3) return "0" + digits; // 739 -> 0739
  if(digits.length === 2) return digits + "00";
  return digits.padStart(4,"0").slice(0,4);
}
function sameTime(a,b){
  const A = normHHMM(a), B = normHHMM(b);
  if(!A || !B) return false;
  return A === B;
}
function fmtAny(x){
  const n = normHHMM(x);
  return n ? n.slice(0,2)+":"+n.slice(2,4) : "—";
}

/* =========================================================
   COLOUR RULES (as agreed)
   White = scheduled (no realtime)
   Green = forecast/confirmed (realtime present and equals booked OR just present)
   Red = delayed (realtime present and differs)
   Red + strike = cancelled
   ========================================================= */
function cssFor(cls){
  if(cls === "delayed") return "red";
  if(cls === "forecast") return "green";
  return ""; // scheduled -> white
}

/* ---------- A) TL (status.json): booked vs realtime ---------- */
function classifyTL(booked, realtime){
  if(!realtime) return "scheduled";
  if(!booked) return "forecast";
  return sameTime(realtime, booked) ? "forecast" : "delayed";
}
function timeRangeTL(depB, depR, arrB, arrR, cancelled){
  if(cancelled){
    return `<span class="red"><span class="strike">${fmtAny(depB)}</span>–<span class="strike">${fmtAny(arrB)}</span></span>`;
  }
  const c1 = classifyTL(depB, depR);
  const c2 = classifyTL(arrB, arrR);
  const cls = (c1 === "delayed" || c2 === "delayed") ? "delayed"
            : (c1 === "forecast" || c2 === "forecast") ? "forecast"
            : "scheduled";
  const css = cssFor(cls);
  return `<span class="${css}">${fmtAny(depR || depB)}–${fmtAny(arrR || arrB)}</span>`;
}

/* ---------- B) BL (xfer.json): booked vs used + IsEstimated ---------- */
function classifyXfer(booked, used, isEstimated){
  if(!isEstimated) return "scheduled";
  if(!booked || !used) return "forecast";
  return sameTime(used, booked) ? "forecast" : "delayed";
}
function timeRangeXfer(depB, depU, depEst, arrB, arrU, arrEst, cancelled){
  if(cancelled){
    return `<span class="red"><span class="strike">${fmtAny(depB)}</span>–<span class="strike">${fmtAny(arrB)}</span></span>`;
  }
  const c1 = classifyXfer(depB, depU, !!depEst);
  const c2 = classifyXfer(arrB, arrU, !!arrEst);
  const cls = (c1 === "delayed" || c2 === "delayed") ? "delayed"
            : (c1 === "forecast" || c2 === "forecast") ? "forecast"
            : "scheduled";
  const css = cssFor(cls);

  const dep = (depEst ? depU : depB);
  const arr = (arrEst ? arrU : arrB);
  return `<span class="${css}">${fmtAny(dep)}–${fmtAny(arr)}</span>`;
}

/* ---------------- TL (STE→WIM) ---------------- */
function renderTL(s){
  const el = document.getElementById("tl_app");
  if(!s || s.error){
    el.innerHTML = `<div class="tl-stack"><div class="route">STE-WIM</div><div class="time red">Error</div></div>`;
    return;
  }

  const o = s.origin || {}, d = s.destination || {};
  const cancelled = !!(o.isCancelled || d.isCancelled || s.status === "cancelled");

  const depB = o.bookedDeparture || s.gbttBookedDeparture || null;
  const depR = o.realtimeDeparture || null;
  const arrB = d.bookedArrival || null;
  const arrR = d.realtimeArrival || null;

  const today = londonYMD(0);
  const tomorrow = londonYMD(1);
  const runDate = (s.runDate || s.date || "").slice(0,10);
  const dayLabel = runDate===today ? "Today" : (runDate===tomorrow ? "Tomorrow" : (runDate || "—"));

  const content = cancelled
    ? `<div class="time red"><span class="strike">${fmtAny(depB)}</span> CANCELLED</div>`
    : `<div class="time">${timeRangeTL(depB, depR, arrB, arrR, false)}</div>`;

  const plat = (o.platform || d.platform)
    ? `<div class="sub">Plat ${o.platform||"?"} · Plat ${d.platform||"?"}</div>`
    : "";

  el.innerHTML = `<div class="tl-stack">
    <div class="sub">${dayLabel}</div>
    <div class="route">STE-WIM</div>
    ${content}
    ${plat}
  </div>`;
}
async function loadTL(){
  try{
    const r = await fetch("./status.json?ts="+Date.now(), {cache:"no-store"});
    renderTL(await r.json());
  }catch{
    renderTL({error:true});
  }
}
loadTL();
setInterval(loadTL, 60000);

/* ---------------- BL (SRC→CLJ→IMW) ---------------- */
function renderBL(data){
  const el = document.getElementById("bl_app");
  if(!data || data.error){
    el.innerHTML = `<div class="time-xs red">No data</div>`;
    return;
  }

  const out = [];

  const today = londonYMD(0);
  const tomorrow = londonYMD(1);
  const runDate = (data.runDate || "").slice(0,10);
  const dayLabel = data.dayLabel || (runDate===today ? "Today" : (runDate===tomorrow ? "Tomorrow" : (runDate || "—")));

  /* Direct block */
  out.push(`<div class="mini-stack">`);
  out.push(`<div class="sub">${dayLabel}</div>`);
  out.push(`<div class="route-mini">SRC-IMW</div>`);

  if(data.direct){
    const cancelled = data.direct.status === "cancelled";

    const depB = data.direct.srcDep || null;
    const depU = data.direct.srcDepUsed || depB;
    const depE = !!data.direct.srcDepIsEstimated;

    const arrB = data.direct.imwArr || null;
    const arrU = data.direct.imwArrUsed || arrB;
    const arrE = !!data.direct.imwArrIsEstimated;

    if(cancelled){
      out.push(`<div class="time-mini red"><span class="strike">${fmtAny(depB)}</span> CANCELLED</div>`);
    }else{
      out.push(`<div class="time-mini">${timeRangeXfer(depB, depU, depE, arrB, arrU, arrE, false)}</div>`);
    }

    out.push(`<div class="sub">Plat ${data.direct.srcPlat||"?"} · Plat ${data.direct.imwPlat||"?"}</div>`);
  }else{
    const dp = data.datePath || runDate || "";
    out.push(`<div class="sub muted">No direct SRC→IMW 07:25 service for ${dp}</div>`);
  }

  out.push(`</div><div class="direct-gap"></div>`);

  /* Headers */
  out.push(`
    <div class="xfer-wrap">
      <div class="xfer-header">
        <div class="title">SRC-CLJ</div>
        <div class="title">Trans' for IMW</div>
        <div class="title">CLJ-IMW</div>
      </div>
  `);

  /* Rows */
  for(const leg of (data.legs || [])){
    // SRC->CLJ
    const dep1B = leg.srcDep || null;
    const dep1U = leg.srcDepUsed || dep1B;
    const dep1E = !!leg.srcDepIsEstimated;

    const arr1B = leg.cljArr || null;
    const arr1U = leg.cljArrUsed || arr1B;
    const arr1E = !!leg.cljArrIsEstimated;

    // CLJ->IMW
    const dep2B = leg.cljDep || null;
    const dep2U = leg.cljDepUsed || dep2B;
    const dep2E = !!leg.cljDepIsEstimated;

    const arr2B = leg.imwArr || null;
    const arr2U = leg.imwArrUsed || arr2B;
    const arr2E = !!leg.imwArrIsEstimated;

    const cancelled2 = leg.status === "cancelled";

    const warn = (leg.transferViable === false) || (leg.transferOk === false);
    const transClass = warn ? "trans-warn" : "trans-ok";
    const minsTxt = (leg.transferMins == null) ? "—" : `${leg.transferMins}m`;

    out.push(`
      <div class="xrow">
        <div class="left-cell">
          <div class="time-xs">${timeRangeXfer(dep1B, dep1U, dep1E, arr1B, arr1U, arr1E, false)}</div>
          <div class="sub plat-both">Plat ${leg.srcPlat||"?"} · Plat ${leg.cljPlatArr||"?"}</div>
        </div>

        <div class="mid-cell">
          <div class="pair">
            <div class="transfer ${transClass}">
              <strong>Plat</strong> ${leg.cljPlatArr||"?"} <span class="arrow">→</span> <strong>Plat</strong> ${leg.cljPlatDep||"?"}
            </div>
            <div class="sub">${minsTxt}</div>
          </div>
        </div>

        <div class="right-cell">
          <div class="time-xs">${timeRangeXfer(dep2B, dep2U, dep2E, arr2B, arr2U, arr2E, cancelled2)}</div>
          <div class="sub">Plat ${leg.cljPlatDep||"?"} · Plat ${leg.imwPlat||"?"}</div>
        </div>
      </div>
    `);
  }

  out.push(`</div>`);
  el.innerHTML = out.join("");
}

async function loadBL(){
  try{
    const r = await fetch("./xfer.json?ts="+Date.now(), {cache:"no-store"});
    renderBL(await r.json());
  }catch{
    renderBL({error:true});
  }
}
loadBL();
setInterval(loadBL, 120000);

/* ---------------- TfL planned engineering works (route-relevant) ---------------- */
const TFL_LINE_ID = "district";
const ROUTE_STOPS = ["Wimbledon", "Parsons Green"];

function isRouteRelevant(text){
  if(!text) return false;
  const t = text.toLowerCase();
  return ROUTE_STOPS.every(s => t.includes(s.toLowerCase()));
}

function plannedCandidatesFromLine(line){
  const out = [];

  for(const ls of (line?.lineStatuses || [])){
    const vps = ls.validityPeriods || [];
    const isPlanned =
      vps.some(v => (v.category||"") === "PlannedWork") ||
      /planned|engineering|works|closure/i.test(ls.statusSeverityDescription||"") ||
      /planned|engineering|works|closure/i.test(ls.reason||"");
    if(!isPlanned) continue;

    const reason = ls.reason || "";
    const disruptionTexts = (ls.disruption && [
      ls.disruption.description,
      ls.disruption.summary,
      ls.disruption.detail
    ].filter(Boolean).join(" — ")) || "";
    const affectedStops = (ls.disruption?.affectedStops || []).map(s => s.commonName).filter(Boolean).join(" · ");
    const affectedRoutes = (ls.disruption?.affectedRoutes || []).map(r => r.name).filter(Boolean).join(" · ");
    const blob = [reason, disruptionTexts, affectedStops, affectedRoutes].filter(Boolean).join(" | ");

    out.push({ blob, vps, core: (ls.statusSeverityDescription || "Planned works").trim() });
  }

  for(const d of (line?.disruptions || [])){
    const txt = [d.description, d.summary, d.detail].filter(Boolean).join(" — ");
    if(!/planned|engineering|works|closure/i.test(txt)) continue;
    out.push({ blob: txt, vps: [], core: "Planned works" });
  }

  return out;
}

function extractRelevantPlannedFromLine(line){
  const hits = [];
  for(const item of plannedCandidatesFromLine(line)){
    if(!isRouteRelevant(item.blob)) continue;

    const start = item.vps[0]?.fromDate || "";
    const end = item.vps[0]?.toDate || "";
    const when = start ? `${shortDate(start)}${end ? "–"+shortDate(end) : ""}` : "";
    const msg = item.blob ? `${item.core}: ${item.blob}` : item.core;
    hits.push({ when, msg });
  }
  hits.sort((a,b) => a.msg.length - b.msg.length);
  return hits[0] || null;
}

async function loadDistrictPlanned(){
  const el = document.getElementById("dl_planned");
  if(!el) return;

  const start = londonISODate(0);
  const end = londonISODate(14);
  const url = `https://api.tfl.gov.uk/Line/${TFL_LINE_ID}/Status/${start}/to/${end}?detail=true`;

  try{
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`TfL HTTP ${r.status}`);
    const js = await r.json();

    const line = Array.isArray(js) ? js[0] : null;
    const planned = extractRelevantPlannedFromLine(line);

    if(planned){
      const prefix = planned.when ? `Planned (${planned.when})` : "Planned";
      el.textContent = `${prefix}: ${planned.msg}`;
      el.style.display = "block";
    }else{
      el.style.display = "none";
      el.textContent = "";
    }
  }catch{
    el.style.display = "none";
    el.textContent = "";
  }
}
loadDistrictPlanned();
setInterval(loadDistrictPlanned, 30*60*1000);
</script>
</body>
</html>

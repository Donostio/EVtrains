<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Morning Board</title>
<style>
  :root {
    --bg:#000;
    --fg:#eaeaea;
    --muted:#9aa0a6;
    --green:#58d27a;
    --amber:#ffa000;
    --red:#ff3b30;
  }
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:1fr 1fr;
    gap:0;
    height:100%;
  }
  .tile{
    background:#000;
    color:var(--fg);
    border:none;
    overflow:hidden;
    display:grid;
    place-items:center;
  }
  iframe{
    width:100%;
    height:100%;
    border:none;
    background:#000;
  }

  /* Main typography */
  .route{
    font-weight:800;
    letter-spacing:.06em;
    margin-bottom:.6rem;
    font-size:clamp(14px,3vw,24px);
  }
  .time{
    font-weight:800;
    line-height:1.1;
    font-size:clamp(28px,9vw,64px);
  }
  .sub{
    font-size:clamp(12px,2.5vw,16px);
    color:var(--muted);
    margin-top:.35rem;
  }
  .strike{text-decoration:line-through}
  .green{color:var(--green)}
  .amber{color:var(--amber)}
  .red{color:var(--red)}
  .muted{color:var(--muted)}

  /* TL centering */
  #tl_app{ text-align:center; }

  /* BL 40% smaller variants + indent + spacer */
  .route-sm{
    font-weight:800;
    letter-spacing:.06em;
    margin-bottom:.35rem;
    font-size: clamp(10px, 1.8vw, 16px);
  }
  .time-sm{
    font-weight:800;
    line-height:1.1;
    font-size: clamp(17px, 5.4vw, 38px);
  }
  .indent{ padding-left: 2.25em; }
  .spacer{ height: clamp(8px, 2.5vw, 16px); }
</style>
</head>
<body>
  <div class="grid">
    <!-- TOP LEFT: 07:44 STE→WIM -->
    <section class="tile">
      <div id="tl_app">Loading…</div>
    </section>

    <!-- TOP RIGHT: District Line iframe -->
    <section class="tile">
      <iframe
        src="https://donostio.github.io/DLstatus/?embed=1&theme=dark"
        loading="lazy"
        referrerpolicy="no-referrer">
      </iframe>
    </section>

    <!-- BOTTOM LEFT: SRC→CLJ→IMW -->
    <section class="tile">
      <div id="bl_app">Loading…</div>
    </section>

    <!-- BOTTOM RIGHT: Weather iframe -->
    <section class="tile">
      <iframe
        src="https://donostio.github.io/EvieWeather/?embed=1&theme=dark"
        loading="lazy"
        referrerpolicy="no-referrer">
      </iframe>
    </section>
  </div>

<script>
const fmt = t => t ? t.slice(0,2)+":"+t.slice(2) : "—";

/* helpers for your new rules */
function timeDisplay(booked, real, status){
  // if delayed and realtime is different → "(booked) realtime"
  if(status === 'delayed' && real && real !== booked){
    return `<span class="muted">(${fmt(booked)})</span> ${fmt(real)}`;
  }
  // else (on_time or early) → booked only
  return `${fmt(booked)}`;
}
function pairDisplay(depBooked, depReal, arrBooked, arrReal, status){
  return `${timeDisplay(depBooked, depReal, status)} <span class="muted">-</span> ${timeDisplay(arrBooked, arrReal, status)}`;
}

/* ---------- TOP LEFT (STE→WIM) ---------- */
function renderTL(s){
  const el = document.getElementById('tl_app');
  if(!s || s.error){
    el.innerHTML = `<div class="route">STE-WIM</div><div class="time red">Error</div>`;
    return;
  }
  const o = s.origin || {};
  const d = s.destination || {};
  // treat 'early' visually like on_time per your instruction
  let status = s.status === 'delayed' ? 'delayed' : 'on_time';

  const depBooked = o.bookedDeparture || s.gbttBookedDeparture || null;
  const depReal   = o.realtimeDeparture || null;
  const arrBooked = d.bookedArrival || null;
  const arrReal   = d.realtimeArrival || null;

  const line = pairDisplay(depBooked, depReal, arrBooked, arrReal, status);
  const colorCls = status === 'delayed' ? 'red' : 'green';

  const platHTML = (o.platform || d.platform)
    ? `<div class="sub">Plat ${o.platform || "?"} · Plat ${d.platform || "?"}</div>`
    : "";

  el.innerHTML = `<div class="route">STE-WIM</div><div class="time ${colorCls}">${line}</div>${platHTML}`;
}
async function loadTL(){
  try{
    const r = await fetch('./status.json?ts='+Date.now(), { cache:'no-store' });
    renderTL(await r.json());
  }catch{
    renderTL({ error:true });
  }
}
loadTL();
setInterval(loadTL, 60000);

/* ---------- BOTTOM LEFT (SRC→CLJ→IMW) ---------- */
function renderBL(data){
  const el = document.getElementById('bl_app');
  if(!data || data.error){ el.innerHTML = `<div class="time-sm red">No data</div>`; return; }

  const toM = t => t ? (parseInt(t.slice(0,2))*60 + parseInt(t.slice(2))) : null;

  const out = [];

  // ----- Direct block -----
  out.push(`<div class="route-sm">SRC-IMW (direct)</div>`);
  if (data.direct){
    // treat 'early' visually like on_time
    const st = data.direct.status === 'delayed' ? 'delayed' : 'on_time';
    const color = st === 'delayed' ? 'red' : 'green';
    const dep = timeDisplay(data.direct.srcDep, data.direct.srcDepReal, st);
    const arr = timeDisplay(data.direct.imwArr, data.direct.imwArrReal, st);

    out.push(`<div class="time-sm ${color}">${dep} <span class="muted">-</span> ${arr}</div>`);
    out.push(`<div class="sub">Plat ${data.direct.srcPlat||"?"} · Plat ${data.direct.imwPlat||"?"}</div>`);
  } else {
    out.push(`<div class="sub muted">No direct SRC→IMW 07:25 service for ${data.datePath}</div>`);
  }

  // Spacer line
  out.push(`<div class="spacer"></div>`);

  // ----- Legs + connection bullets -----
  for(const leg of (data.legs||[])){
    const srcDep = leg.srcDep;
    const srcDepReal = leg.srcDepReal;
    const cljArr = leg.cljArr;
    const cljArrReal = leg.cljArrReal;

    // leg status: delayed if either leg appears late; otherwise on_time/early → show booked
    const legStatus = 'on_time'; // conservative: headers are schedule-focused
    const headerLine = pairDisplay(srcDep, srcDepReal, cljArr, cljArrReal, legStatus);

    out.push(`
      <div class="route-sm">
        SRC - CLJ ${headerLine} <span class="muted">(arr. plat ${leg.cljPlatArr || "?"})</span>
      </div>
    `);

    // Up to two connections, indented
    (leg.connections||[]).slice(0,2).forEach(c=>{
      const depCLJBooked = c.cljDep || null;
      const depCLJReal   = c.cljDepReal || null;
      const arrIMWBooked = c.imwArr || null;
      const arrIMWReal   = c.imwArrReal || null;

      const connStatus = c.status === 'delayed' ? 'delayed' : 'on_time';
      const pair = pairDisplay(depCLJBooked, depCLJReal, arrIMWBooked, arrIMWReal, connStatus);

      // transfer mins (use realtime where available)
      const cljArrRef = (cljArrReal || cljArr);
      const mArr  = toM(cljArrRef);
      const mDep  = toM(depCLJReal || depCLJBooked);
      let xfer = (mArr!=null && mDep!=null) ? (mDep - mArr) : null;
      if (xfer!=null && xfer<0) xfer = null;

      const warn = (xfer!=null && xfer < 4);
      const minsText = xfer==null ? "?mins" : `${xfer}mins`;
      const xferHTML = warn
        ? `<span class="red">${minsText} transfer to plat ${c.cljPlat||"?"}!</span>`
        : `<span class="muted">${minsText} transfer to plat ${c.cljPlat||"?"}</span>`;

      out.push(`
        <div class="sub indent">
          • ${pair} (CLJ ${xferHTML})
        </div>
      `);
    });

    // Spacer between leg groups
    out.push(`<div class="spacer"></div>`);
  }

  if(!data.legs?.length){
    out.push(`<div class="sub muted">No CLJ connections ≥1 min after arrival.</div>`);
  }

  el.innerHTML = out.join("");
}
async function loadBL(){
  try{
    const r = await fetch('./xfer.json?ts='+Date.now(), { cache:'no-store' });
    renderBL(await r.json());
  }catch{
    renderBL({ error:true });
  }
}
loadBL();
setInterval(loadBL, 60000);
</script>
</body>
</html>
